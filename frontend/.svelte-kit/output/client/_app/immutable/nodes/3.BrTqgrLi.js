import{a as b,f as h,e as U,s as Q,c as Rt}from"../chunks/CXN8AEkE.js";import{i as Nt}from"../chunks/Ba5BHlZf.js";import{o as qt}from"../chunks/PPGuM6Ad.js";import{m as Et,o as At,r as i,q as l,t as n,s as S,a as e,v as J,n as te,w as u,x as v,y as zt,z as Mt}from"../chunks/DrZxtosp.js";import{i as P}from"../chunks/C09UTFEA.js";import{e as D,i as H}from"../chunks/BnX6E_pk.js";import{r as g,s as Pt,a as _}from"../chunks/DJ05b8fX.js";import{b as w,a as Ft}from"../chunks/BMwTRFU8.js";import{b as F}from"../chunks/D0pToFsK.js";import{s as Ot,a as Bt}from"../chunks/DbI0K5eF.js";import{a as A,s as Ct}from"../chunks/C0-kHXY5.js";var Ut=h('<p class="text-muted">Nur für Admins.</p>'),Jt=h('<div class="card"> </div>'),Dt=h('<div class="actions actions-between"><span> </span> <select class="select"><option>Nutzer</option><option>Materialwart</option><option>Admin</option></select></div>'),Ht=h('<div class="actions actions-between"><div><strong>NFC aktivieren</strong> <p class="text-muted">NFC-Kennungen für Material anzeigen.</p></div> <label class="toggle"><input type="checkbox"/></label></div>'),Kt=h("<option> </option>"),Lt=h("<option>Benutzerdefiniert</option>"),Wt=h('<input class="input" type="number" min="1"/> <select class="select"><option>Stunden</option><option>Tage</option><option>Wochen</option></select>',1),Gt=h("<option> </option>"),It=h("<option> </option>"),Qt=h('<div class="field"><label>Min. Rückmeldungen (%)</label> <input class="input" type="number" min="0" max="100"/></div>'),Vt=h('<div class="field"><label>Startdatum</label> <input class="input" type="date"/></div> <div class="field"><label>Rhythmus</label> <select class="select"><option>Kein Rhythmus</option><option>Täglich</option><option>Wöchentlich</option><option>Monatlich</option></select></div> <div class="field"><label>Uhrzeit</label> <input class="input" type="time"/></div>',1),Zt=h('<div class="card"><div class="actions actions-between"><select class="select"><!><!></select> <label class="toggle"><input type="checkbox"/> Aktiv</label> <!> <select class="select"><option>Alle Rollen</option><option>Nutzer</option><option>Materialwart</option><option>Admin</option></select> <select class="select"><option>Alle Nutzer</option><!></select> <div class="actions"><button class="btn btn-primary">Speichern</button> <button class="btn btn-danger">Löschen</button></div></div> <div class="form-grid"><div class="field"><label>Fenster-Start</label> <input class="input" type="time"/></div> <div class="field"><label>Fenster-Ende</label> <input class="input" type="time"/></div> <div class="field"><label>Cooldown (Stunden)</label> <input class="input" type="number" min="0"/></div> <div class="field"><label>Event-Typ</label> <select class="select"></select></div> <!> <!></div> <div class="form-grid"><div class="field"><label>Titel (Template)</label> <input class="input" placeholder="z. B. Termin-Erinnerung"/></div> <div class="field"><label>Text (Template)</label> <textarea class="input" rows="3"></textarea></div></div> <p class="text-muted"></p></div>'),jt=h('<!> <section class="card-grid grid-2"><div class="card"><h3 class="section-title">Rollenverwaltung</h3> <p class="text-muted">Benutzernamen und Rollen sofort ändern</p> <div class="card-grid"></div></div> <div class="card"><h3 class="section-title">Feature-Flags</h3> <p class="text-muted">Schalter wirken sofort auf die NFC-Anzeige.</p> <div class="form-grid"></div></div></section> <section class="card"><h3 class="section-title">Ruhezeiten</h3> <p class="text-muted">Push-Benachrichtigungen werden in dieser Zeit unterdrückt.</p> <div class="form-grid"><div class="field"><label for="quietStart">Start</label> <input id="quietStart" class="input" type="time"/></div> <div class="field"><label for="quietEnd">Ende</label> <input id="quietEnd" class="input" type="time"/></div></div> <div class="actions"><button class="btn btn-primary">Speichern</button></div></section> <section class="card"><div class="actions actions-between"><div><h3 class="section-title">Push-Regeln</h3> <p class="text-muted">Regeln für Push-Benachrichtigungen</p></div> <button class="btn btn-outline">Neue Regel</button></div> <div class="card-grid"></div></section>',1),Xt=h('<section><h2 class="page-title">Admin</h2> <!></section>');function va(tt,at){Et(at,!1);const Ne=()=>Bt(Ct,"$session",it),[it,nt]=Ot();let K=J([]),L=J([]),c=J([]),V=J(""),Z=J("21:00"),j=J("06:00");const qe=[{value:"event-reminder",label:"Termin-Erinnerung"},{value:"availability-missing",label:"Rückmeldung fehlt"},{value:"packlist-missing",label:"Packliste fehlt"},{value:"packlist-incomplete",label:"Packliste unvollständig"},{value:"event-created",label:"Termin erstellt"},{value:"event-updated",label:"Termin geändert"},{value:"event-canceled",label:"Termin abgesagt"},{value:"inventory-low",label:"Material unter Mindestmenge"},{value:"weekly-admin",label:"Wöchentliche Admin-Erinnerung"}],st=a=>qe.some(o=>o.value===a),lt=["","Gruppenstunde","Lager","Aktion","Sonstiges"],ot=a=>["availability-missing","packlist-missing","packlist-incomplete","weekly-admin","inventory-low"].includes(a),rt=a=>a%168===0?{value:a/168,unit:"weeks"}:a%24===0?{value:a/24,unit:"days"}:{value:a,unit:"hours"},O=async()=>{S(V,"");try{S(K,await A("/api/admin/users")),S(L,await A("/api/admin/settings")),S(c,(await A("/api/admin/push-rules")).map(o=>{const R=Number(o.lead_time_hours)||0,{value:z,unit:W}=rt(R);return{...o,target_user_id:o.target_user_id??"",target_role:o.target_role??"",lead_value:z,lead_unit:W,title_template:o.title_template??"",body_template:o.body_template??"",min_response_percent:o.min_response_percent??"",event_type:o.event_type??"",send_start:o.send_start??"",send_end:o.send_end??"",schedule_start_date:o.schedule_start_date??"",schedule_every:o.schedule_every??"",schedule_time:o.schedule_time??"",cooldown_hours:o.cooldown_hours??24}}));const a=new Map(e(L).map(o=>[o.key,o.value]));S(Z,a.get("quiet_hours_start")??"21:00"),S(j,a.get("quiet_hours_end")??"06:00")}catch{S(V,"Admin-Daten konnten nicht geladen werden.")}},dt=async(a,o)=>{await A(`/api/admin/users/${a}/role`,{method:"PUT",body:JSON.stringify({role:o})}),await O()},Ee=async a=>{await A("/api/admin/settings",{method:"PUT",body:JSON.stringify(a.map(o=>({key:o.key,value:o.value})))}),await O()},vt=async()=>{const a=[...e(L).filter(o=>o.key!=="quiet_hours_start"&&o.key!=="quiet_hours_end"),{key:"quiet_hours_start",value:e(Z)},{key:"quiet_hours_end",value:e(j)}];await Ee(a)},_t=async(a,o)=>{const R=e(L).map(z=>z.key===a?{...z,value:o?"true":"false"}:z);await Ee(R)},ct=async()=>{const a=new Date().toISOString().slice(0,10);await A("/api/admin/push-rules",{method:"POST",body:JSON.stringify({rule_type:"event-reminder",enabled:!0,lead_time_hours:24,title_template:"Termin-Erinnerung",body_template:"{event.title} startet am {event.start}",cooldown_hours:24,schedule_start_date:a,schedule_every:"daily",schedule_time:"08:00"})}),await O()},pt=async a=>{const o=a.lead_unit==="weeks"?168:a.lead_unit==="days"?24:1,R=a.rule_type==="event-reminder"?Math.max(1,Number(a.lead_value||0)*o):Number(a.lead_time_hours||0);await A(`/api/admin/push-rules/${a.id}`,{method:"PUT",body:JSON.stringify({rule_type:a.rule_type,enabled:a.enabled===1||a.enabled===!0,lead_time_hours:R,target_user_id:a.target_user_id||null,target_role:a.target_role||null,title_template:a.title_template||null,body_template:a.body_template||null,min_response_percent:a.min_response_percent===""||a.min_response_percent===null?null:Number(a.min_response_percent),event_type:a.event_type||null,send_start:a.send_start||null,send_end:a.send_end||null,schedule_start_date:a.schedule_start_date||null,schedule_every:a.schedule_every||null,schedule_time:a.schedule_time||null,cooldown_hours:a.cooldown_hours===""||a.cooldown_hours===null?null:Number(a.cooldown_hours)})}),await O()},ut=async a=>{confirm("Regel wirklich löschen?")&&(await A(`/api/admin/push-rules/${a}`,{method:"DELETE"}),await O())};qt(O),Nt();var ae=Xt(),mt=i(l(ae),2);{var bt=a=>{var o=Ut();b(a,o)},ht=a=>{var o=jt(),R=te(o);{var z=y=>{var t=Jt(),B=l(t,!0);n(t),u(()=>Q(B,e(V))),b(y,t)};P(R,y=>{e(V)&&y(z)})}var W=i(R,2),ie=l(W),Ae=i(l(ie),4);D(Ae,5,()=>e(K),H,(y,t,B)=>{var $=Dt(),x=l($),k=l(x,!0);n(x);var f=i(x,2);u(()=>{e(t),v(()=>{})});var N=l(f);N.value=N.__value="user";var T=i(N);T.value=T.__value="materialwart";var q=i(T);q.value=q.__value="admin",n(f),n($),u(()=>Q(k,e(t).email)),F(f,()=>e(t).role,C=>(e(t).role=C,v(()=>e(K)))),U("change",f,C=>dt(e(t).id,C.currentTarget.value)),b(y,$)}),n(Ae),n(ie);var ze=i(ie,2),Me=i(l(ze),4);D(Me,5,()=>e(L),H,(y,t)=>{var B=Rt(),$=te(B);{var x=k=>{var f=Ht(),N=i(l(f),2),T=l(N);g(T),n(N),n(f),u(()=>Pt(T,e(t).value==="true")),U("change",T,q=>_t(e(t).key,q.currentTarget.checked)),b(k,f)};P($,k=>{e(t).key==="nfc_enabled"&&k(x)})}b(y,B)}),n(Me),n(ze),n(W);var ne=i(W,2),se=i(l(ne),4),le=l(se),Pe=i(l(le),2);g(Pe),n(le);var Fe=i(le,2),Oe=i(l(Fe),2);g(Oe),n(Fe),n(se);var Be=i(se,2),yt=l(Be);n(Be),n(ne);var Ce=i(ne,2),oe=l(Ce),gt=i(l(oe),2);n(oe);var Ue=i(oe,2);D(Ue,5,()=>e(c),H,(y,t,B)=>{var $=Zt(),x=l($),k=l(x);u(()=>{e(t),v(()=>{})});var f=l(k);D(f,1,()=>qe,H,(s,d)=>{var r=Kt(),m=l(r,!0);n(r);var p={};u(()=>{Q(m,e(d).label),p!==(p=e(d).value)&&(r.value=(r.__value=e(d).value)??"")}),b(s,r)});var N=i(f);{var T=s=>{var d=Lt(),r={};u(()=>{r!==(r=e(t).rule_type)&&(d.value=(d.__value=e(t).rule_type)??"")}),b(s,d)};P(N,s=>{e(t).rule_type&&!st(e(t).rule_type)&&s(T)})}n(k);var q=i(k,2),C=l(q);g(C),zt(),n(q);var Je=i(q,2);{var ft=s=>{var d=Wt(),r=te(d);g(r);var m=i(r,2);u(()=>{e(t),v(()=>{})});var p=l(m);p.value=p.__value="hours";var M=i(p);M.value=M.__value="days";var G=i(M);G.value=G.__value="weeks",n(m),w(r,()=>e(t).lead_value,E=>(e(t).lead_value=E,v(()=>e(c)))),F(m,()=>e(t).lead_unit,E=>(e(t).lead_unit=E,v(()=>e(c)))),b(s,d)};P(Je,s=>{e(t).rule_type==="event-reminder"&&s(ft)})}var X=i(Je,2);u(()=>{e(t),v(()=>{})});var re=l(X);re.value=re.__value="";var de=i(re);de.value=de.__value="user";var ve=i(de);ve.value=ve.__value="materialwart";var De=i(ve);De.value=De.__value="admin",n(X);var Y=i(X,2);u(()=>{e(t),v(()=>{e(K)})});var _e=l(Y);_e.value=_e.__value="";var wt=i(_e);D(wt,1,()=>e(K),H,(s,d)=>{var r=Gt(),m=l(r,!0);n(r);var p={};u(()=>{Q(m,e(d).email),p!==(p=e(d).id)&&(r.value=(r.__value=e(d).id)??"")}),b(s,r)}),n(Y);var He=i(Y,2),Ke=l(He),kt=i(Ke,2);n(He),n(x);var ce=i(x,2),pe=l(ce),Le=l(pe),ue=i(Le,2);g(ue),n(pe);var me=i(pe,2),We=l(me),be=i(We,2);g(be),n(me);var he=i(me,2),Ge=l(he),ye=i(Ge,2);g(ye),n(he);var ge=i(he,2),Ie=l(ge),ee=i(Ie,2);u(()=>{e(t),v(()=>{})}),D(ee,5,()=>lt,H,(s,d)=>{var r=It(),m=l(r,!0);n(r);var p={};u(()=>{Q(m,e(d)===""?"Alle Typen":e(d)),p!==(p=e(d))&&(r.value=(r.__value=e(d))??"")}),b(s,r)}),n(ee),n(ge);var Qe=i(ge,2);{var $t=s=>{var d=Qt(),r=l(d),m=i(r,2);g(m),n(d),u(()=>{_(r,"for",`rule-${e(t).id}-min-response`),_(m,"id",`rule-${e(t).id}-min-response`)}),w(m,()=>e(t).min_response_percent,p=>(e(t).min_response_percent=p,v(()=>e(c)))),b(s,d)};P(Qe,s=>{e(t).rule_type==="availability-missing"&&s($t)})}var xt=i(Qe,2);{var Tt=s=>{var d=Vt(),r=te(d),m=l(r),p=i(m,2);g(p),n(r);var M=i(r,2),G=l(M),E=i(G,2);u(()=>{e(t),v(()=>{})});var xe=l(E);xe.value=xe.__value="";var Te=i(xe);Te.value=Te.__value="daily";var Se=i(Te);Se.value=Se.__value="weekly";var Xe=i(Se);Xe.value=Xe.__value="monthly",n(E),n(M);var Ye=i(M,2),et=l(Ye),Re=i(et,2);g(Re),n(Ye),u(()=>{_(m,"for",`rule-${e(t).id}-start-date`),_(p,"id",`rule-${e(t).id}-start-date`),_(G,"for",`rule-${e(t).id}-schedule-every`),_(E,"id",`rule-${e(t).id}-schedule-every`),_(et,"for",`rule-${e(t).id}-schedule-time`),_(Re,"id",`rule-${e(t).id}-schedule-time`)}),w(p,()=>e(t).schedule_start_date,I=>(e(t).schedule_start_date=I,v(()=>e(c)))),F(E,()=>e(t).schedule_every,I=>(e(t).schedule_every=I,v(()=>e(c)))),w(Re,()=>e(t).schedule_time,I=>(e(t).schedule_time=I,v(()=>e(c)))),b(s,d)};P(xt,s=>{ot(e(t).rule_type)&&s(Tt)})}n(ce);var fe=i(ce,2),we=l(fe),Ve=l(we),ke=i(Ve,2);g(ke),n(we);var Ze=i(we,2),je=l(Ze),$e=i(je,2);Mt($e),n(Ze),n(fe);var St=i(fe,2);St.textContent=`Variablen: {event.title}, {event.start}, {event.end}, {event.type}, {event.location},
              {user.name}, {user.role}, {item.name}, {item.quantity}, {item.min_quantity}`,n($),u(()=>{_(Le,"for",`rule-${e(t).id}-send-start`),_(ue,"id",`rule-${e(t).id}-send-start`),_(We,"for",`rule-${e(t).id}-send-end`),_(be,"id",`rule-${e(t).id}-send-end`),_(Ge,"for",`rule-${e(t).id}-cooldown`),_(ye,"id",`rule-${e(t).id}-cooldown`),_(Ie,"for",`rule-${e(t).id}-event-type`),_(ee,"id",`rule-${e(t).id}-event-type`),_(Ve,"for",`rule-${e(t).id}-title-template`),_(ke,"id",`rule-${e(t).id}-title-template`),_(je,"for",`rule-${e(t).id}-body-template`),_($e,"id",`rule-${e(t).id}-body-template`)}),F(k,()=>e(t).rule_type,s=>(e(t).rule_type=s,v(()=>e(c)))),Ft(C,()=>e(t).enabled,s=>(e(t).enabled=s,v(()=>e(c)))),F(X,()=>e(t).target_role,s=>(e(t).target_role=s,v(()=>e(c)))),F(Y,()=>e(t).target_user_id,s=>(e(t).target_user_id=s,v(()=>e(c)))),U("click",Ke,()=>pt(e(t))),U("click",kt,()=>ut(e(t).id)),w(ue,()=>e(t).send_start,s=>(e(t).send_start=s,v(()=>e(c)))),w(be,()=>e(t).send_end,s=>(e(t).send_end=s,v(()=>e(c)))),w(ye,()=>e(t).cooldown_hours,s=>(e(t).cooldown_hours=s,v(()=>e(c)))),F(ee,()=>e(t).event_type,s=>(e(t).event_type=s,v(()=>e(c)))),w(ke,()=>e(t).title_template,s=>(e(t).title_template=s,v(()=>e(c)))),w($e,()=>e(t).body_template,s=>(e(t).body_template=s,v(()=>e(c)))),b(y,$)}),n(Ue),n(Ce),w(Pe,()=>e(Z),y=>S(Z,y)),w(Oe,()=>e(j),y=>S(j,y)),U("click",yt,vt),U("click",gt,ct),b(a,o)};P(mt,a=>{!Ne()||Ne().role!=="admin"?a(bt):a(ht,!1)})}n(ae),b(tt,ae),At(),nt()}export{va as component};
